<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup Condition="!$(DefineConstants.Contains('DISABLE_SBP'))">
    <SbpAllowLocalSource Condition="'$(SbpAllowLocalSource)'==''">True</SbpAllowLocalSource>
    <SbpEnablePublish Condition="'$(SbpEnablePublish)'==''">True</SbpEnablePublish>
    <SbpEnablePublish Condition="$(DefineConstants.Contains('SBP_DISABLE_PUBLISH'))">False</SbpEnablePublish>
    <SbpTimeoutInSeconds Condition="'$(SbpTimeoutInSeconds)'==''">300</SbpTimeoutInSeconds>
    <SbpCopyLocalSourcePdbToSymbolCache Condition="'$(SbpCopyLocalSourcePdbToSymbolCache)'==''">True</SbpCopyLocalSourcePdbToSymbolCache>
    <SbpCopyLocalSourcePdbToSymbolCache Condition="$(DefineConstants.Contains('SBP_DISABLE_COPY_LOCAL_SOURCE_PDB'))">False</SbpCopyLocalSourcePdbToSymbolCache>
    <SbpPrereleaseVersioningMode Condition="'$(SbpPrereleaseVersioningMode)'==''">Automatic</SbpPrereleaseVersioningMode>
  </PropertyGroup>

  <UsingTask
    TaskName="PreparePublishTask"
    AssemblyFile="$(MSBuildThisFileDirectory)..\tools\Sundew.Build.Publish.m.dll"/>
  <UsingTask
    TaskName="AdjustProjectReferenceVersionsTask"
    AssemblyFile="$(MSBuildThisFileDirectory)..\tools\Sundew.Build.Publish.m.dll"/>
  <UsingTask
    TaskName="PublishTask"
    AssemblyFile="$(MSBuildThisFileDirectory)..\tools\Sundew.Build.Publish.m.dll"/>

  <Target Name="SbpPreparePublishNuGetDuringClean" BeforeTargets="_GetOutputItemsFromPack" DependsOnTargets="SbpPreparePublishNuGet" Condition="!$(DefineConstants.Contains('DISABLE_SBP')) AND $(DesignTimeBuild) != true AND $(BuildingProject) != false">
  </Target>
  <Target Name="SbpPreparePublishNuGetDuringBuild" AfterTargets="Build" BeforeTargets="Pack" DependsOnTargets="SbpPreparePublishNuGet" Condition="!$(DefineConstants.Contains('DISABLE_SBP')) AND $(DesignTimeBuild) != true AND $(BuildingProject) != false" >
  </Target>

  <Target Name="SbpPreparePublishNuGet">
    <PreparePublishTask Condition="!$(DefineConstants.Contains('DISABLE_SBP'))"
                 SolutionDir="$(SolutionDir)"
                 PackageId="$(PackageId)"
                 Version="$(Version)"
                 PrereleaseVersioningMode="$(SbpPrereleaseVersioningMode)"
                 ProductionSource="$(SbpProductionSource)"
                 IntegrationSource="$(SbpIntegrationSource)"
                 DevelopmentSource="$(SbpDevelopmentSource)"
                 LocalSource="$(SbpLocalSource)"
                 AllowLocalSource="$(SbpAllowLocalSource)"
                 SourceName="$(SbpSourceName)">
      <Output PropertyName="PackageVersion" TaskParameter="PackageVersion"/>
      <Output PropertyName="SbpSource" TaskParameter="Source"/>
      <Output PropertyName="SbpSymbolsSource" TaskParameter="SymbolsSource"/>
      <Output PropertyName="SbpEnablePublish" TaskParameter="PublishPackages" Condition="'$(SbpEnablePublish)'=='True'"/>
    </PreparePublishTask>
  </Target>

  <Target Name="AdjustProjectReferenceVersions" BeforeTargets="GenerateNuspec">
    <AdjustProjectReferenceVersionsTask ResolvedProjectReferences="@(_ResolvedProjectReferencePaths)" ProjectReferences="@(_ProjectReferencesWithVersions)" Condition="!$(DefineConstants.Contains('DISABLE_SBP')) AND $(DesignTimeBuild) != true AND $(BuildingProject) != false">
      <Output TaskParameter="AdjustedProjectReferences" ItemName="_NewProjectReferencesWithVersions" />
    </AdjustProjectReferenceVersionsTask>

    <ItemGroup>
      <_ProjectReferencesWithVersions Remove="@(_ProjectReferencesWithVersions)"/>
      <_ProjectReferencesWithVersions Include ="@(_NewProjectReferencesWithVersions)"/>
    </ItemGroup>
  </Target>

  <Target Name="SbpPublishNuGet" AfterTargets="Pack">
    <PublishTask Condition="!$(DefineConstants.Contains('DISABLE_SBP')) AND $(DesignTimeBuild) != true AND $(BuildingProject) != false"
                 SolutionDir="$(SolutionDir)"
                 ProjectDir="$(MSBuildProjectDirectory)"
                 PackageId="$(PackageId)"
                 Version="$(PackageVersion)"
                 PackInputs="@(NuGetPackInput)"
                 OutputPath="$(MSBuildProjectDirectory)/$(OutputPath)"
                 PackageOutputPath="$(PackageOutputPath)"
                 Source="$(SbpSource)"
                 SymbolsSource="$(SbpSymbolsSource)"
                 ApiKey="$(SbpApiKey)"
                 SymbolApiKey="$(SbpSymbolApiKey)"
                 PublishPackages="$(SbpEnablePublish)"
                 TimeoutInSeconds="$(SbpTimeoutInSeconds)"
                 NoServiceEndpoint="$(SbpNoServiceEndpoint)"
                 SkipDuplicate="$(SbpSkipDuplicate)"
                 CopyLocalSourcePdbToSymbolCache="$(SbpCopyLocalSourcePdbToSymbolCache)"
                 SymbolCacheDir="$(SbpSymbolCacheDir)"
                 PublishLogFormats="$(SbpPublishLogFormats)">
      <Output ItemName="SbpPackages" TaskParameter="PackagePaths"/>
    </PublishTask>
  </Target>
</Project>